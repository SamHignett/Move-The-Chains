name: Deploy Azure Static Web App

on:
  workflow_call: 
    inputs:
      app_name:
          required: true
          type: string
      target_env:
        required: true
        type: string
      app_location:
        required: true
        type: string
      
jobs:
    deploy:    
        runs-on: ubuntu-latest
        environment:
          name: ${{ inputs.target_env }}

        steps:
          - uses: actions/checkout@v3
            with:
              submodules: true
              lfs: false

          - name: Set up Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '20'

          - name: Install dependencies
            run: npm install
            working-directory: ${{ inputs.app_location }}

          - name: Build project
            run: npm run build
            working-directory: ${{ inputs.app_location }}
            
          - name: Set AZURE_TOKEN for Portal
            if: ${{ inputs.app_name == 'portal' }}
            run: |
              echo "App detected as Portal, setting AZURE_TOKEN"
              echo "Secret length: ${#AZURE_STATIC_WEB_APP_PORTAL_DEPLOYMENT_TOKEN}"
              echo "AZURE_TOKEN=${{ secrets.AZURE_STATIC_WEB_APP_PORTAL_DEPLOYMENT_TOKEN }}" >> $GITHUB_ENV
            env:
              AZURE_STATIC_WEB_APP_PORTAL_DEPLOYMENT_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APP_PORTAL_DEPLOYMENT_TOKEN }} 
              
          - name: Deploy SWA
            uses: Azure/static-web-apps-deploy@v1
            with:
              azure_static_web_apps_api_token: ${{ env.AZURE_TOKEN }}
              repo_token: ${{ secrets.GITHUB_TOKEN }}
              action: "upload"
              app_location: ${{ inputs.app_location }}
              output_location: ".next"
              skip_app_build: true
              deployment_environment: ${{ inputs.target_env }}